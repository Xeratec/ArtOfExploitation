/**
* @file sht.c
* @author Philip Wiese
* @date 01 Nov 2016
* @brief Programm to execute raw hex code
*
* This programm
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>

void print_usage(int, char **);
unsigned char *convert_string(unsigned char *);

int main(int argc, char *argv[]) {
	unsigned char shellcode[1024];
	unsigned char *buffer;
	memset(shellcode, 0x90, 1024);

	int c, show_raw = 0;
	opterr = 0;
	if (argc < 2) {
		print_usage(argc, argv);
		return 0;
	}
	while ((c = getopt (argc, argv, "hsr:H:")) != -1)
    switch (c)
      {
      case 'h':
			print_usage(argc, argv);
			return 1;
        	break;
      case 'H':
			buffer = convert_string(optarg);
			strncpy(shellcode, buffer, 1024);
        	break;
      case 'r':
   		strncpy(shellcode, optarg, 1024);
		   break;
		case 's':
   		show_raw = 1;
		   break;
		case '?':
         if (optopt == 'r')
           fprintf (stderr, "Option -%c requires a raw hex argument.\n", optopt);
          if (optopt == 'H')
           fprintf (stderr, "Option -%c requires a hex string argument.\n", optopt);
         else if (isprint (optopt))
           fprintf (stderr, "Unknown option `-%c'.\n", optopt);
         else {
           fprintf (stderr, "Unknown option character `\\x%x'.\n", optopt);
           print_usage(argc, argv);
          }
        return 1;
      default:
        	abort();
      }
   int length = strlen(shellcode);   
	printf("[Info] Length: %d\n", length);
	
	if (show_raw) {
		printf("#--- Raw Shellcode: ---#\n");
		unsigned char byte;
		unsigned int i,j;
		for (i=0; i<length; i++) {
			if ( ( (i%8) == 0)) {
				printf(" ");
			}
			printf("%02x ", shellcode[i]);
			if ( ( (i%8) == 7) || (i==length-1)) {
				for (j=0; j<7-(i%8); j++) printf("   ");
				printf("\n");
			}
		}
   }
   
   // Executing Code
   printf("[Info] Executing Code...\n");
	int (*func) ();
	func = ( int(*)()) shellcode;
	(int) (*func)();
	return 0;
}

unsigned char *convert_string(unsigned char *buffer) {
	char *p;
	int cnt = (strlen(buffer) + 1) / 3; // Whether or not there's a trailing space
	unsigned char *result = (unsigned char *)malloc(cnt);
	unsigned char c, *r;
	
	for (p = buffer, r = result; *p; p += 3) {
		 if (sscanf(p, "%02x", (unsigned int *)&c) != 1) {
		     break; // Didn't parse as expected
		 }
		 *r++ = c;
	}
	
	// Compiler optimization ???
	// Without this statement *result gets overwritten
	int length = strlen(result);
	
	return result;
}

void print_usage(int argc, char *argv[]) {
	printf("Usage: %s [options]\n", argv[0]);
	printf("Options:\n");
	printf("  -s\t\t\tShow raw hex code\n");
	printf("  -r <hex raw>\t\tInput is raw hex code\n");
	printf("  -H <hex string>\tInput is hex string\n");
	printf("\nExample:\n");
	printf("  %s -sr $(cat exec_shell_v1)\n", argv[0]);
	printf("  %s -sH \"31 C0 50 68 2F 2F 73 68 68 2F 62 69 6E 89 E3 50 89 E2 53 89 E1 B0 0B CD 80\"\n", argv[0]);
	
}
